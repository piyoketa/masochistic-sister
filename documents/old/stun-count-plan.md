# ビームゴブリン／スタンカウント実装計画

## 目的
- 新敵「ビームゴブリン」を追加する。
  - 見た目: 小さいゴブリンが巨大なビーム台を運搬。
  - HP 150、特性: 天の鎖無効（天の鎖無効）、スタンカウント40。
  - 行動:
    - パワー充填: 攻撃力+80。1回でも攻撃したらこの強化は消える。
    - ビーム: 単発20ダメージ。
- スタンカウントの概念を State として導入し、1ターンに40ダメージを与えるとそのターン行動不能にする。

## 実装方針
1. スタンカウント State
   - `StunCountState` (id例: `state-stun-count`) を新規追加。
   - `magnitude` を閾値（例: 40）として扱う。
   - そのターンに受けた累積ダメージを追跡するフィールドを持たせ、Snapshot に含めてリプレイ可能にする（例: `progressThisTurn`）。
   - 1ターンに閾値到達時:
     - そのターンの残り行動をスキップさせる（敵キューをクリアし、即座に `SkipTurnAction` を挿入）。
     - スタン状態のログ/アニメーション指示を追加（後で設計に合わせる）。
   - ターン開始時に `progressThisTurn` をリセット。

2. ダメージ累積のフック
   - ダメージ解決後のポイント（`Damages.resolve` または `OperationRunner` のダメージ適用箇所）で、被弾した敵に `StunCountState` がある場合に累積を更新。
   - 閾値到達判定を行い、到達したらスタントリガー処理を呼ぶ。
   - 累積ダメージがターンを跨ぐ際はリセットする必要があるので、ターン開始ハンドラ/敵ターン開始ハンドラにリセット処理を追加。

3. スタン発動時の挙動
   - スタンした敵: そのターンの queuedActions を空にし、`SkipTurnAction` を即時キューイング。`hasActedThisTurn` の扱いを確認し、二重行動を防ぐ。
   - 天の鎖無効など他特性との衝突がないか確認（天の鎖とは別ルールでスタンさせる）。
   - アニメーション/ログ: Stun専用の ActionLogEntry または既存 stage-event を使うか検討（最初はログのみでも可）。

4. ビームゴブリン敵データ
   - `BeamGoblinEnemy` を追加。HP 150。`states` に `LargeState` と `StunCountState(40)` を付与。
   - 技:
     - `PowerChargeAction`: 自身に攻撃力+80 の State を付与（1回攻撃すると剥がれる仕様 → 付与 State を post-hit で消す or Action 前後で消す）。非スタック、消滅時ログを出す。
     - `BeamAction`: 単発20ダメージの攻撃（`DamagePattern single 20`）。
   - 行動パターン: まずパワー充填→ビームを繰り返す（仮）。必要に応じて `nextActions` を組む。
   - EnemyTeam 登録・SampleField などへの組み込みは別途検討。

5. 既存コードへの影響
   - Snapshot に `StunCountState` の進捗を含めるため、`State` の serialize/clone ロジックが対応しているか確認し、足りなければ `toSnapshot` / `fromSnapshot` 相当を実装。
   - ターン開始リセットの呼び出し: `Battle.startPlayerTurn` / `startEnemyTurn` などで敵のスタン進捗をクリアする処理を追加。
   - 反復ダメージ（multi-hit）でも閾値を正しく超えるよう、累積判定を各ヒット後に実施。

## 不明点・要確認
- スタン効果の継続時間: 「このターン転倒して行動しなくなる」とあるが、ターン終了後に復帰でよいか？（推奨: そのターンのみ行動不能、次ターン復帰）
- パワー充填の消滅条件: 「一度でも攻撃すると消滅」→ 攻撃 Action 実行直後にバフを自動で外す想定でよいか？
- スタン発動時の表示/演出: 専用の animation stage が必要か、それともログ＋簡易ステータス更新で十分か？
- 複数のスタンカウント State を持つ場合の処理: 単一想定だが、複数あれば閾値の最小値を使うか？（推奨: 最初に見つけたものを適用し、複数は想定外として無視）

## 実装ステップ（案）
1. `StunCountState` を追加（進捗フィールド・リセット/更新メソッド・スナップショット対応）。
2. ダメージ適用後フックを追加し、スタン閾値チェック → スタン発動処理（敵キューリセット＋SkipTurn挿入）。
3. ターン開始時に進捗リセットする処理を `Battle` / `EnemyTeam` に追加。
4. `BeamGoblinEnemy` / 関連 Action を実装し、`StunCountState(40)` と `LargeState` を付与。
5. 動作確認（手動デモで 1ターンに40ダメージ与えた際に即スタンすること、次ターン復帰すること）。
6. アニメーション/ログ整備（必要に応じて stage-event 追加）。***
