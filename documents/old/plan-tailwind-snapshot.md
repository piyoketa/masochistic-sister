## 目的
- 追い風（味方バフ）発動時、効果音再生開始と同時に「加速」などのステート変化が画面へ反映されるよう、アニメーションとスナップショット更新の順序を見直す。

## 現状整理（確認済み箇所）
- 敵行動エントリでは `OperationRunner.attachEnemyActAnimations` がバッチを作成し、`enemy-action` バッチの `snapshot` はバフ適用後の状態（ステート反映済み）を持つ。ref: `src/domain/battle/OperationRunner.ts:1145-1154`
- View 側の `buildAnimationScriptFromEntry` では、各バッチの stage-event コマンドを **先に**積み、続いて patch/update-snapshot を積むため、バッチ内の最初の stage-event（例: audio）が走る時点では旧スナップショットのまま。ref: `src/view/ViewManager.ts:1080-1125`
- `createBatch` のデフォルトでは patch を付けるため、スナップショットが更新されるのは stage-event コマンドの後で、バッチ全体の wait を消化した後になるケースが多い。ref: `src/domain/battle/OperationRunner.ts:1438-1468`
- 追い風はバフ系でダメージ演出がないため、最初の stage-event が audio になりやすく、音再生が始まってからステートが可視化される。

## 解決したい課題
- 追い風の効果音再生開始時点で対象敵のステート（加速）が UI に反映されるように、スナップショット更新のタイミングを前倒ししたい。

## 方針案（選択肢とおすすめ）
1. **バッチ内でスナップショット更新を最初に挿入する（order変更）**
   - stage-event の前に patch/update-snapshot コマンドを積むよう `buildAnimationScriptFromEntry` を調整。
   - 利点: すべてのアニメーションで「演出開始時に状態が一致」する一貫した挙動。
   - 懸念: 「演出前は旧状態を表示する」ことを前提にしているケース（例: 敵撃破演出でHP0にする瞬間を演出後にしたい等）がないか確認が必要。
   - **おすすめ**: まずこの順序変更を検討し、影響が出そうなステージ（defeat 等）がないか確認する。
2. **バフ系（state-card / audio）専用でスナップショット更新を先行させる**
   - `enemy-action` バッチのみ、stage-event 生成前に patch を挿入する特例を入れる、あるいは `skipSnapshotUpdate: true` にして冒頭に `update-snapshot` コマンドを追加する。
   - 利点: 影響範囲をバフ演出に限定できる。
   - 懸念: 部分的な分岐が複雑になり、今後の演出追加で漏れが出やすい。
3. **「音＋ステート反映」を別バッチに分割する**
   - audio 専用バッチを作り、そのバッチの snapshot を先に適用。続く state-card バッチでは差分パッチをスキップする等。
   - 利点: 音だけ先行させたり、演出順を柔軟に制御できる。
   - 懸念: バッチ数が増え、時間計算や手札差分ウォッチャへの影響を再検証する必要がある。

現時点のおすすめは **案1（コマンド順序を「snapshot→stage→wait」に変更）** で、影響が懸念される defeat 演出などを確認した上で進める。

## 進め方（作業ステップ）
1. **挙動トレース**: 追い風再生時の `enemy-action` バッチ内容と生成される AnimationCommand の順序をロガーで確認し、音再生と patch 適用のギャップを再現ログに残す。
2. **影響箇所洗い出し**: snapshot更新順が変わった場合に問題が出そうなステージ（`defeat` / `card-trash` / `deck-draw` など）を一覧化し、演出意図を確認する。
3. **実装案選択**: 案1 をベースに、必要なら defeat 系のみ旧順序を維持する等のガードを検討する。
4. **実装**: `buildAnimationScriptFromEntry` で、各バッチのコマンド積み順を「update-snapshot/patch → stage-events → wait」に変更する（もしくは `createBatch` でオプション化）。
5. **動作確認**: 追い風で音開始と同時にステートが表示されることを手動確認。敵撃破・カード移動など他の演出で意図しないフリッカーがないか簡易チェック。
6. **調整・コメント追記**: 仕様意図（演出開始時点で最新状態を表示させるための順序）をコメントとしてコードに残す。

## 不明点・要確認
1. **演出順序の期待**  
   - 質問: 敵撃破やデッキドローなど、演出前に旧状態を見せたいケースはあるか？  
   - 選択肢: (a) 全ステージで演出開始時に新状態を表示する / (b) defeat など一部だけ旧状態を維持する。  
   - おすすめ: (a) 全体統一。特例が必要なら defeat など個別に `skipSnapshotUpdate` を付ける。
2. **音とステート表示の同期優先度**  
   - 質問: 追い風以外のバフ／デバフも音と同時に状態変化を見せる方針でよいか？  
   - 選択肢: (a) バフ/デバフ系は全て音と同時表示 / (b) 追い風のみ特例。  
   - おすすめ: (a) 一貫させる（音＝効果発動開始の合図として扱う）。
3. **手札差分ウォッチャへの影響**  
   - 質問: snapshot→stage 先行により、`card-add` 系演出で手札差分が早く適用されることを許容できるか？  
   - 選択肢: (a) 許容する / (b) 手札イベントのみ従来順序を維持する。  
   - おすすめ: (a) 許容。ただし実装時にドロー／メモリ生成の挙動を確認する。
