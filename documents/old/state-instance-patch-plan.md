---
title: apply-patch 時に State インスタンスを保持する改善計画
updated: 2025-11-16
---

## 目的
- `apply-patch` 適用後でも `State` インスタンスのメソッド（例: `description()`）を保持し、`BattleEnemyArea` などの描画時にクラスメソッド欠落による例外を防ぐ。
- Patch に含まれないプロパティは可能な限り元スナップショットの参照を引き継ぎ、不要な深いクローンでクラス情報が失われるのを防ぐ。

## 背景 / 課題
- 現状 `ViewManager.applySnapshotPatch` では `cloneValue` にて `JSON.parse(JSON.stringify(...))` を使ってスナップショットを複製してから差分を適用している。
- この過程で `State` やその他クラスインスタンスのプロトタイプ情報が失われ、`state.description is not a function` が発生している。
- Patch に含まれないプロパティも丸ごとクローンされるため、クラス保持だけでなく参照維持もできていない。

## 対応方針（概要）
1. `applySnapshotPatch` のクローン戦略を見直し、「変更箇所のみ深いコピー」「未変更箇所は元参照を保持」する差分マージに置き換える。
   - 変更が必要なノードに限り、元値の型を保ったままシャローコピーを作成し、その配下で必要な箇所だけ再帰マージする。
   - 配列やプレーンオブジェクトを優先的に処理し、クラスインスタンスはそのまま参照を残す（必要に応じて浅いコピーまでに留める）。
2. 追加の安全策として、`structuredClone` が安全に使える場合は活用を検討するが、クラス保持が保証されない／エラーになりうるケースは避け、明示的マージを優先する。
3. Patch が `undefined` を含むキーはスキップする既存仕様を維持し、fallback スナップショットが無い場合のエラー文言は現行を踏襲する。

## 実装タスク
- [ ] `applySnapshotPatch` / `mergeSnapshotPatch` を「必要箇所のみコピー＋マージ」方式へ書き換える。
  - 変更対象ノードのみ新規オブジェクト（または配列）を生成し、未変更ノードは元参照を共有する。
  - クラスインスタンスは検出したらそのまま引き継ぎ、再帰しない。
- [ ] `cloneValue` の JSON 依存を除去し、上記マージに不要なら削除 or シンプル化する。
- [ ] ユニットテスト追加：
  - `State` インスタンスが `apply-patch` 後も `description` を呼べること。
  - Patch に含まれない配列/オブジェクトが元参照のまま維持されること（例: `enemies` がそのまま）。
  - Patch で一部だけ更新した場合、元スナップショットの同一参照を使っていることを確認するテスト。
- [ ] 既存テストの期待値調整（必要なら）。

## 不明点・要確認事項
1. **未変更プロパティの参照維持の粒度**
   - 選択肢A: スナップショット全体で「変更が無ければ同一参照」を保持する（最もプロトタイプ保持に強い）。
   - 選択肢B: トップレベルのみ新しいオブジェクトを作り、深部は変更箇所のみコピー、それ以外は参照共有（UI のリアクティブ更新と整合を取りやすい）。
   - 推奨: **B**（再描画用のトップレベル更新は維持しつつ、深部は参照共有でクラス保持）。
2. **配列の取り扱い**
   - 選択肢A: 配列丸ごと差し替え（現在と同じ挙動）。
   - 選択肢B: 配列も要素単位でマージ（複雑だが参照保持しやすい）。
   - 推奨: **A**（まずはシンプルに、配列は差し替え。`State` 配列は元参照が必要な場合、パッチ側に配列を渡さない運用でカバー）。
3. **クラス判定の方法**
   - 選択肢A: `value instanceof Object && value.constructor !== Object` などでプレーンオブジェクトとクラスを判定。
   - 選択肢B: `isPlainObject` のユーティリティを実装してそれ以外はクラス扱い。
   - 推奨: **B**（可読性と安全性のためプレーン判定を明示）。

## 追加で気を付けること
- スナップショットのトップレベルは新規オブジェクトにして Vue のリアクティブチェーンを維持しつつ、内部の非変更部分は参照共有でクラスを温存する。
- 既存の `apply-patch` 仕様（`changes` が無い場合はエラー）や `previousSnapshot` 更新の挙動は維持する。
