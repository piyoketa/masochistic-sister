# 山札オーバーレイを App.vue で集約し、親からイベントを扱えるようにする計画

## 背景
- 山札オーバーレイ（`PileOverlay`）自体は `App.vue` 直下で描画しているが、開閉トリガーは各 View（`FieldView` / `BattleView` など）で `usePileOverlayStore` を直接呼ぶ形に分散している。
- `PlayerStatusHeader` の「デッキ」ボタンは `MainGameLayout` 経由で親に `deck-click` をエミットするが、親がハンドラを持たない画面（例: `/field/start-story`）ではオーバーレイを開けない。
- ルートをまたいで再利用できるよう、親（`App.vue`）でオーバーレイ制御を一元化し、イベントを受け取れる経路を用意したい。

## 目的
- 「デッキ」ボタンを押したとき、どの画面でも親側（`App.vue`）でイベントを受け取り山札オーバーレイを開閉できるようにする。
- 既存の山札/捨て札表示の仕様（フィールド: ソート済み表示、バトル: シャッフル表示など）を崩さず、他機能への影響を最小化する。

## 実施ステップ案
1. **現状調査とデータ形態の棚卸し**  
   - `FieldView` / `BattleView` で生成している `CardInfo` リストの形式（フィールドはタイプ順ソート、バトルは秘匿のためシャッフル＋捨て札あり）と、`pileOverlayStore` に依存している箇所（`watch` で再オープンなど）を洗い出す。
2. **グローバル制御インターフェースの設計**  
   - `App.vue` で受け取れるように `provide/inject` か小さなイベントバスを用意し、`requestDeckOverlay(payload)` / `requestDiscardOverlay(payload)` のような API を定義する。  
   - payload には `deckCards`, `discardCards`, `source`（battle/field など）を含め、バトル用のシャッフル要求を明示できるようにする。
3. **App.vue での受け口とストア連携**  
   - 上記 API を `provide` し、受け取った payload を元に `pileOverlayStore.openDeck/openDiscard` を呼ぶ。  
   - ルート遷移時にオーバーレイが残らないよう `router.afterEach` 等で `close` するか検討。
4. **各 View のイベント配線の整理**  
   - `FieldView` / `BattleView` / `StartStoryView` で `@deck-click` を受けたら新 API に payload を渡すよう変更し、`pileOverlayStore` 直接利用を極力削減。  
   - バトルの `watch`（デッキ更新時に再オープン・再シャッフルする処理）は新 API 経由で同等に動くよう調整する。不要になった `PileOverlay` の import や未使用コードを削除。
5. **回帰確認と UI の動作チェック**  
   - `/field` と `/field/start-story` で「デッキ」ボタンがオーバーレイを開閉できること。  
   - バトル中（ヘッダー・手札UIのオーバーレイボタン双方）で山札/捨て札が表示され、デッキ変化に追従して再描画されること。  
   - オーバーレイが画面遷移をまたいで残らないこと、他のオーバーレイ（`PileChoiceOverlay` など）と表示競合しないこと。

## 影響範囲と確認観点
- `pileOverlayStore` を直接呼んでいた箇所の置き換えに伴う挙動差（特にバトルでのシャッフル/再オープン挙動）。
- ルート遷移時の状態リセット有無（オーバーレイが残存しないか）。
- イベント伝搬経路の変更によるレイアウト（`MainGameLayout`）や他ヘッダーボタンへの副作用の有無。
- 未使用になった import / コンポーネントの削除漏れ。

## 不明点・意思決定が必要な点
- **バトル時のデッキ表示順**: 秘匿のため従来通り毎回シャッフル表示を維持すべきか、App 集約後も同様にするか。  
  - 選択肢: 1) 現行通りバトル時のみシャッフル、2) 全画面でソート表示に統一。  
  - おすすめ: **現行通りバトル時のみシャッフルを維持**（仕様逸脱を避ける）。
- **ルート遷移時のクローズタイミング**: オーバーレイを自動クローズするか、利用者に任せるか。  
  - 選択肢: 1) `router.afterEach` で強制 close、2) 現行通りストア状態を保持。  
  - おすすめ: **afterEach で close**（別画面へ遷移後の残留を防止）。
- **データ供給責務の所在**: deck/discard の生成を各 View で続けるか、App 側で生成するか。  
  - 選択肢: 1) 各 View でこれまで通り生成し payload 経由で渡す、2) App で統一生成（ビューが提供するのは元データ/ID のみ）。  
  - おすすめ: **現行通り各 View で `CardInfo` を組み立てて payload 渡し**（バトル/フィールドでの表示仕様を維持）。

上記方針で進めて問題ないか、ご確認をお願いします。***
