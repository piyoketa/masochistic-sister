# プレイヤー状態進行ルール刷新 実装計画

## 目的
- プレイヤーの状態進行ロジックを専用モジュールへ集約し、イベント通知（ダメージ/回復/状態付与）に基づいて更新する。
- 進行度の前半/後半パート、およびダメージ表現・表情差分を新仕様に沿って管理する。
- 戦闘外（報酬画面など）でも同一ロジックで表示が反映されるようにする。

## 方針
- 状態進行専用モジュールを新設し、イベント通知は Battle/報酬処理などから集約的に行う。
- 判定・選択ロジックは全てモジュール内で実施し、最終結果を store へ反映する。
- View は store から値を受け取り、`PlayerImageComponent` に渡す。

## 実装ステップ（案）
1. **状態進行専用モジュールの新設**
   - 例: `src/domain/progress/PlayerStateProgressRule.ts` など。
   - 役割:
     - 前半パート(1〜6)の増減判定
     - 後半パートのダメージ表現適用/解除
     - 現在の総ダメージ量計算と表情レベル決定
   - 重要: モジュール内で store 更新まで行う（依存注入方式 or store直接参照）。

2. **store の状態設計**
   - `playerStore` or 専用 store に以下を追加:
     - `stateProgressCount`（前半用: 1〜6）
     - `appliedDamageExpressions`（適用済みのダメージ表現IDと適用理由）
     - `totalDamageAmount`（表情判定用の総ダメージ量）
     - `faceExpressionLevel`（0/2/3 などの表情差分状態）総ダメージ量からのgetters
   - バトル間で持ち越される。セーブデータには反映されない。

3. **イベント通知の配線**
   - **被ダメージ**: Battle（または View/ActionLog）から `onDamageTaken` を通知。
   - **腐食付与**: `onStateApplied` で `stateId`/`magnitude` を通知。
   - **HP回復**:
     - 報酬回復（前半: -1 / 後半: ダメージ表現の解除）
     - それ以外の回復（後半の解除対象に含めるか要確認）-> 「口づけ」による回復なども含める
   - View/Model どこから通知するかを決定（MVV境界に注意）。

4. **前半パートの更新ロジック**
   - 腐食付与 or 20ダメ以上で `+1`。
   - 報酬回復時に `-1`。
   - 最小1、最大6でクランプ。

5. **後半パートのダメージ表現適用**
   - イベント発生時に「未適用」かつ「条件一致」の表現を1つ適用。
   - 優先度: ダメージ量が大きいものを優先。
   - シーケンス表現は「前段が適用済みの場合のみ」適用可能。

6. **後半パートの回復処理**
   - 回復量以下で解除できる表現を、ダメージ量の大きい順で解除。
   - 「腐食によって適用された表現」は解除対象外（適用理由を保持）。

7. **表情差分の更新**
   - 総ダメージ量:
     - 50未満: なし
     - 100未満: 表情2
     - 100以上: 表情3
   - `PlayerImageComponent` に `faceExpressionLevel` などを渡し、`/assets/players/damages/表情2.png` / `表情3.png` を重ねる。

8. **PlayerImageComponent の拡張**
   - `damageOverlays` を受け取り、`public/assets/players/damages` の画像を重ねる。
   - 描画順は `FACE_DIFF_SOURCES` より下に挿入する。
   - `ImageHub` のプリロード対象に damage 画像を追加。

9. **不要コードの整理**
   - 旧 `PlayerStateProgressManager`（Battle 内の manager）や `stateProgressCount` の Snapshot 依存を整理。
   - 旧 achievement 連携（2/5/8/10）との整合を確認し、必要なら更新/削除。

10. **テスト**
   - 前半パートの増減（腐食/20ダメ/報酬回復）
   - 後半パートの適用・解除・優先順位
   - 表情差分の閾値

## 確定事項（回答反映）
1. **後半パート移行後の `stateProgressCount` の扱い**
   - 6に固定して以降は変化なし。
2. **シーケンス表現の「ダメージ量」定義**
   - 条件の閾値をそのままダメージ量として扱う（例: 胸1=20）。
3. **「腐食によって適用された表現」の判定基準**
   - 腐食条件を満たす表現は常に「腐食由来」とみなす。
4. **後半パートの適用対象イベント**
   - ダメージ発生・腐食付与のみで適用判定を行う。
5. **表情2/表情3の表示位置**
   - `damages/表情2.png` / `表情3.png` を damage overlay として挿入する。
6. **状態進行の永続化範囲**
   - バトル間で持ち越すが、セーブ対象には含めない。
7. **実績（状態進行 2/5/8/10）の扱い**
   - 既存実績は廃止する。
8. **Snapshot / View 連携**
   - `appliedDamageExpressions` と `faceExpressionLevel` は `BattleSnapshot` に含める。
   - 戦闘画面では `BattleSnapshot` を参照し、報酬画面など戦闘外では `playerStore` を参照する。

## 不明点・確認したい事項
- 追加の不明点はありません。

## 次のアクション
- 上記の確定事項を反映した計画書で問題なければ実装へ進みます。
