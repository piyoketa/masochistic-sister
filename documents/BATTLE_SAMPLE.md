# このドキュメントは何？
- このドキュメントは、`tests/integration/battleSample.spec.ts` の戦闘シナリオを文書化したものです。
- このドキュメントに従い、テスト内容を更新／メンテナンスしてください。

# 新カード
まだ実装されていない新カードについて、このセクションで記載します

## 日課
- Skill
- コスト1
- 効果：２ドロー

# シナリオ1
## 1. 戦闘開始準備
### デッキの初期化
初期デッキは以下の9枚である

- 天の鎖 × 4枚
- 被虐のオーラ × 2枚
- 戦いの準備 × 1枚
- 日課 × 1枚
- 疼き × 1枚

上記9枚を「Card」インスタンスとして生成し、Deckに加える。

### 敵の初期化

以下の４体を「Enemy」インスタンスとして生成する。

〇を付けた方の技をそれぞれの敵の最初の技とする。

- オーク
    - HP: 40/40
    - 技
        - 〇殴打
            - 種別：アタック（単体攻撃）
            - 20ダメージ
        - ビルドアップ
            - 種別：スキル
            - 自分の状態に、打点上昇（10）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- オークダンサー
    - HP: 40/40
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇戦いの舞い
            - 種別：スキル
            - 自分の状態に、加速（1）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- 触手
    - HP: 25/25
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇体液をかける
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「粘液(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- かたつむり
    - HP: 10/10
    - 技
        - 殴打
            - 種別：アタック（単体攻撃）
            - 10ダメージ
        - 〇酸を吐く：5ダメージ
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「腐食(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：防御(20)：受けるダメージを-20する

## 1ターン目

(ここからがstart-player-turn の処理)
- ドローフェイズ
    - 最初のターンは、Deckの上から５枚をHandに加える。
    - 今回はテストなので、以下の５枚を引くことにする。
        - 天の鎖 × 2
        - 戦いの準備 × 1
        - 被虐のオーラ × 1
        - 日課 × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - この時点では何もない
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「被虐のオーラ」を「かたつむり」に使用する
        - 検証すべき結果
            - マナが2になる
            - プレイヤーのHPが145
            - かたつむりが「酸を吐く」の行動をする
            - プレイヤーが攻撃を受けたことにより
                - プレイヤーの手札が6枚になり、状態異常「腐食」とアタック「酸を吐く」を追加される。使用された「被虐のオーラ」は捨て札に移動する。
                - PlayerのStateが「腐食(1)」になる
            - 「かたつむり」は行動済みステータスになる
    - play-card2枚目：「日課」を使用
        - 検証すべき結果
            - マナが1になる
            - 山札の上から2枚を引く
            　　- 今回はテストなので、山札の並び順は固定。
                - プレイヤーの手札が7枚になり、「天の鎖」と「疼き」を引く。使用された「日課」は捨て札に移動する。
    - play-card3枚目：「戦いの準備」を使用
        - 結果として起こること
            - マナが0になる
            - プレイヤーの手札が6枚になり、使用された「戦いの準備」が捨て札に移動する
            - 次の自分のターンの開始時に、マナ＋１のイベントを積む
            
(ここからがend-player-turn の処理)
- ターン終了。敵のターンになる

行動順に従い、敵の行動を処理していく

- オーク → 「殴打」30ダメージ。プレイヤーのHPが115になり、手札に「殴打」が追加されて手札が7枚になる
- オークダンサー → 「戦いの舞い」を発動。自身のStateが「加速（1）」になる。
- 触手 → 「体液をかける」を発動。
    - プレイヤーのHPが15減って100になる
    - ダメージ15の「体液をかける」のカードと、状態異常「粘液」のカードが１枚手札に追加される。手札9枚になる。
- かたつむり → 行動済みのため、このターンは何も行動しない

検証すべき結果
- 敵の行動（Action）名が全て上記通り
- 手札が9枚
- プレイヤーのHPが100
- プレイヤーのStateが「腐食(1)」と「粘液(1)」の２つ
(ここまでがend-player-turn の処理)

## ２ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - が、手札の上限は10枚なので、今回は1枚しか引くことができない。
    - 今回はテストなので、以下の1枚を引くことにする。
        - 被虐のオーラ × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - 前のターンに発動した「戦いの準備」の効果が処理され、マナ＋１され、マナ４になる。
(ここからがend-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「殴打(30ダメージ)」を「かたつむり」に使用する
        - 検証すべき結果
            - マナが3になる
            - かたつむりに10ダメージが入り、かたつむりが「撃破」状態になる
            - 「殴打」が捨て札に移動し、手札が9枚になる
    - play-card2枚目：「酸を吐く」を「触手」に使用する
        - 検証すべき結果
            - マナが2になる
            - 触手に5ダメージ。触手のHPが20になり、Stateが「腐食(1)」になる
            - 手札の「酸を吐く」が捨て札に移動し、手札が8枚になる
    - play-card3枚目：「体液をかける」を「触手」に使用する
        - 検証すべき結果
            - マナが1になる
            - 触手に25ダメージ。触手のHPが0になり、「撃破」状態になる
            - 手札の「体液をかける」が捨て札に移動し、手札が7枚になる
   - play-card4枚目：「腐食」を使用する
        - 検証すべき結果
            - マナが0になる
            - 手札の「腐食」が消滅ゾーンに移動し、手札が6枚になる
            - プレイヤーのStateから「腐食(1)」が消え、「粘液(1)」のみになる     

(ここからがend-player-turn の処理)
- ターン終了
行動順に従い、敵の行動を処理していく

- オーク → 「ビルドアップ」を発動。自身のStateが「打点上昇（10）」になる
- オークダンサー → 「乱れ突き」を発動する。
    - 結果として起こること
        - 10 × 4 = 40ダメージ
        - プレイヤーのHPが60になる
        - 手札に「乱れ突き」が追加されて、手札が7枚になる
- 触手 → 撃破されているので、何もしない
- かたつむり → 撃破されているので、何もしない

検証すべき結果
- 敵の行動（Action）名が全て上記通り
- 手札が7枚
- プレイヤーのHPが60
- プレイヤーのStateが「粘液(1)」の１つ
(ここまでがend-player-turn の処理)

## ３ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - デッキには、残り１枚しかないので、まず、以下の１枚を引く。
        - 天の鎖 × 1
    - 残り１枚のドローが残っているが、デッキが残っていないので、捨て札をシャッフルして、新しいデッキにする。
        - 捨て札をシャッフルし、デッキにする。
    - 上から1枚引く。
        - 今回はテストなので、「酸を吐く」を引いたとする。
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - なにもなし

検証すべき結果
手札が9枚になっている
(ここからがend-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「疼き」を手札の「乱れ突き 10×4」に使用する
        - 検証すべき結果
            - マナが2になる
            - 手札の「疼き」が消滅ゾーンに送られ、手札にもう一枚の「乱れ突き」が追加される。手札に10×4ダメージの「乱れ突き」が2枚ある。手札が9枚になっている。
    - play-card2枚目：「乱れ突き 10×4」を「オーク」に使用
        - 検証すべき結果
            - マナが1になる
            - オークに40ダメージ。HPが0になり、オークが撃破状態になる。
    - play-card3枚目：「乱れ突き 10×4」を「オークダンサー」に使用
        - 検証すべき結果
            - マナが0になる
            - オークダンサーに40ダメージ。HPが0になり、オークダンサーが撃破状態になる。

このタイミングで、全ての敵が撃破されたので、勝利条件が満たされる。


# シナリオ2
## 1. 戦闘開始準備
### デッキの初期化
初期デッキは以下の9枚である

- 天の鎖 × 4枚
- 被虐のオーラ × 2枚
- 戦いの準備 × 1枚
- 日課 × 1枚
- 疼き × 1枚

上記9枚を「Card」インスタンスとして生成し、Deckに加える。

### 敵の初期化

以下の４体を「Enemy」インスタンスとして生成する。

〇を付けた方の技をそれぞれの敵の最初の技とする。

- オークダンサー
    - HP: 40/40
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇戦いの舞い
            - 種別：スキル
            - 自分の状態に、加速（1）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- 鉄花
    - HP: 10/10
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇体液をかける
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「粘液(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：守りの花びら(3)
        - 毎ターン、自分にバリア(3)を付与
          - ドローフェイズ後、処理チェックの段階に行う
          - すでにバリアを持つ場合、毎ターンmagnitudeを3にリセットする
        - バリアとは
            - 攻撃1回分を無効(0ダメージ)にする
            - 連続攻撃の場合、攻撃回数分のバリアを消費する
                - 例えば、5ダメージ × 2回の連続攻撃をバリア(3)の敵に対して使った場合、攻撃は0ダメージ × 2回になり、バリアのmagnitudeは1になる
                - 例えば、5ダメージ × 4回の連続攻撃をバリア(3)の敵に対して使った場合、最初の3回の攻撃はバリアの効果で0になり、5ダメージ × 1回が与えられる
- かまいたち
    - HP: 20/20
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 5ダメージ × 4回
        - 追い風
            - 種別：スキル
              - 対象：味方1体（新しい対象タグ）
              - 特殊効果：指定した味方1体に、State「加速(1)」を付与
                - なお、加速のmagnitudeは累積する（すでに加速(2)なら、+1されて加速(3)になる）
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- かたつむり
    - HP: 30/30
    - 技
        - 殴打
            - 種別：アタック（単体攻撃）
            - 10ダメージ
        - 〇酸を吐く：5ダメージ
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「腐食(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：臆病　最後の1体になったとき、逃走する

# 新概念
## バリア、連続攻撃のダメージ計算
新しいState「バリア」を導入する。
これにより、State同士で、ダメージ計算時の優先度の概念が必要になる。

計算の優先度は以下の通り。
「腐食」=「防御」=「粘液」>「バリア」

また、UI側にダメージ計算結果を渡すときは、以下のようなオブジェクトを渡すことになる。
例えば、5ダメージ × 4回の連続攻撃をバリア(3)の敵に対して使った場合、4回の攻撃モーションがあるが、最初の3回は0ダメージ。最後の1回だけ5ダメージなので、[0,0,0,5]


## 1ターン目

(ここからがstart-player-turn の処理)
- ドローフェイズ
    - 最初のターンは、Deckの上から５枚をHandに加える。
    - 今回はテストなので、以下の５枚を引くことにする。
        - 天の鎖 × 2
        - 戦いの準備 × 1
        - 被虐のオーラ × 1
        - 日課 × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - この時点では何もない
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「被虐のオーラ」を「かたつむり」に使用する
        - 検証すべき結果
            - マナが2になる
            - プレイヤーのHPが145
            - かたつむりが「酸を吐く」の行動をする
            - プレイヤーが攻撃を受けたことにより
                - プレイヤーの手札が6枚になり、状態異常「腐食」とアタック「酸を吐く」を追加される。使用された「被虐のオーラ」は捨て札に移動する。
                - PlayerのStateが「腐食(1)」になる
            - 「かたつむり」は行動済みステータスになる
    - play-card2枚目：「日課」を使用
        - 検証すべき結果
            - マナが1になる
            - 山札の上から2枚を引く
            　　- 今回はテストなので、山札の並び順は固定。
                - プレイヤーの手札が7枚になり、「天の鎖」と「疼き」を引く。使用された「日課」は捨て札に移動する。
    - play-card3枚目：「戦いの準備」を使用
        - 結果として起こること
            - マナが0になる
            - プレイヤーの手札が6枚になり、使用された「戦いの準備」が捨て札に移動する
            - 次の自分のターンの開始時に、マナ＋１のイベントを積む
            
(ここからがend-player-turn の処理)
- ターン終了。敵のターンになる

行動順に従い、敵の行動を処理していく

- オーク → 「殴打」30ダメージ。プレイヤーのHPが115になり、手札に「殴打」が追加されて手札が7枚になる
- オークダンサー → 「戦いの舞い」を発動。自身のStateが「加速（1）」になる。
- 触手 → 「体液をかける」を発動。
    - プレイヤーのHPが15減って100になる
    - ダメージ15の「体液をかける」のカードと、状態異常「粘液」のカードが１枚手札に追加される。手札9枚になる。
- かたつむり → 行動済みのため、このターンは何も行動しない

検証すべき結果
- 敵の行動（Action）名が全て上記通り
- 手札が9枚
- プレイヤーのHPが100
- プレイヤーのStateが「腐食(1)」と「粘液(1)」の２つ
(ここまでがend-player-turn の処理)

## ２ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - が、手札の上限は10枚なので、今回は1枚しか引くことができない。
    - 今回はテストなので、以下の1枚を引くことにする。
        - 被虐のオーラ × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - 前のターンに発動した「戦いの準備」の効果が処理され、マナ＋１され、マナ４になる。
(ここからがend-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「殴打(30ダメージ)」を「かたつむり」に使用する
        - 検証すべき結果
            - マナが3になる
            - かたつむりに10ダメージが入り、かたつむりが「撃破」状態になる
            - 「殴打」が捨て札に移動し、手札が9枚になる
    - play-card2枚目：「酸を吐く」を「触手」に使用する
        - 検証すべき結果
            - マナが2になる
            - 触手に5ダメージ。触手のHPが20になり、Stateが「腐食(1)」になる
            - 手札の「酸を吐く」が捨て札に移動し、手札が8枚になる
    - play-card3枚目：「体液をかける」を「触手」に使用する
        - 検証すべき結果
            - マナが1になる
            - 触手に25ダメージ。触手のHPが0になり、「撃破」状態になる
            - 手札の「体液をかける」が捨て札に移動し、手札が7枚になる
   - play-card4枚目：「腐食」を使用する
        - 検証すべき結果
            - マナが0になる
            - 手札の「腐食」が消滅ゾーンに移動し、手札が6枚になる
            - プレイヤーのStateから「腐食(1)」が消え、「粘液(1)」のみになる     

(ここからがend-player-turn の処理)
- ターン終了
行動順に従い、敵の行動を処理していく

- オーク → 「ビルドアップ」を発動。自身のStateが「打点上昇（10）」になる
- オークダンサー → 「乱れ突き」を発動する。
    - 結果として起こること
        - 10 × 4 = 40ダメージ
        - プレイヤーのHPが60になる
        - 手札に「乱れ突き」が追加されて、手札が7枚になる
- 触手 → 撃破されているので、何もしない
- かたつむり → 撃破されているので、何もしない

検証すべき結果
- 敵の行動（Action）名が全て上記通り
- 手札が7枚
- プレイヤーのHPが60
- プレイヤーのStateが「粘液(1)」の１つ
(ここまでがend-player-turn の処理)

## ３ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - デッキには、残り１枚しかないので、まず、以下の１枚を引く。
        - 天の鎖 × 1
    - 残り１枚のドローが残っているが、デッキが残っていないので、捨て札をシャッフルして、新しいデッキにする。
        - 捨て札をシャッフルし、デッキにする。
    - 上から1枚引く。
        - 今回はテストなので、「酸を吐く」を引いたとする。
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - なにもなし

検証すべき結果
手札が9枚になっている
(ここからがend-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「疼き」を手札の「乱れ突き 10×4」に使用する
        - 検証すべき結果
            - マナが2になる
            - 手札の「疼き」が消滅ゾーンに送られ、手札にもう一枚の「乱れ突き」が追加される。手札に10×4ダメージの「乱れ突き」が2枚ある。手札が9枚になっている。
    - play-card2枚目：「乱れ突き 10×4」を「オーク」に使用
        - 検証すべき結果
            - マナが1になる
            - オークに40ダメージ。HPが0になり、オークが撃破状態になる。
    - play-card3枚目：「乱れ突き 10×4」を「オークダンサー」に使用
        - 検証すべき結果
            - マナが0になる
            - オークダンサーに40ダメージ。HPが0になり、オークダンサーが撃破状態になる。

このタイミングで、全ての敵が撃破されたので、勝利条件が満たされる。


# 新規実装要素
現在のロジックには存在しない要素について追記します。

## 勝利条件/敗北条件
PlayerもしくはEnemyのHPが変動するたびに、勝利条件判定／敗北条件判定を行います。

勝利条件判定：EnemyTeamが持つメソッドで判定します。EnemyTeamに属するEnemyすべてが撃破（もしくは逃走）状態になった場合、ActionLogに`victory`エントリが追加され、Battle全体が「victory」ステータスに変化します。

敗北条件判定：Playerが持つメソッドで判定します。プレイヤーのHPが0になったとき、ActionLogに`gameover`エントリが追加され、Battle全体が「gameover」ステータスに変化します。

フロントエンド側は、ActionLogの勝利Entry、もしくは敗北Entryを受け取ったとき、勝利画面、もしくは敗北画面に移動します。

## 手札上限
手札に上限枚数を設けます。デフォルトで上限枚数は10です。（Handの初期化時に変更できます。）

手札が上限を超える場合、以下の処理を行います。
- デッキからドローの場合：ドローできません。上限数になるまで手札を引き、それ以降は何もしません。
  - フロント側で「手札がいっぱいでドローできません」というアラートを表示するので、ActionLogEntryにフラグを立てて置いてください。
- 敵の攻撃を受け、「記憶」や「状態異常」が手札に追加される場合
  - 現在手札にあるカードの中で、typeがStateカードではなく、かつ最も古いカードを代わりに捨て札に送ります。
