# 戦闘の流れ例

以下の流れを、上記のクラスを使って表現すること。

全ての行動はテキスト出力として、Logクラスに出力し、Log出力を追うことで、戦闘の流れが全て追えるようにすること。

Vitestのテストコードを書き、確認してください。

## 1. 戦闘開始準備

### デッキの初期化

初期デッキは以下の８枚である

- 天の鎖 × 5枚
    - 種別：スキル
    - コスト：１
    - 効果：選択した敵1体は、このターン行動できない
    - CardTags: 消費, 神聖
- 戦いの準備 × 2枚
    - 種別：スキル
    - コスト：１
    - 効果：次のターン開始時、マナ＋１
    - CardTags: なし
- 被虐のオーラ × 1枚
    - 種別：スキル
    - コスト：１
    - 効果：選択した敵一体を即座に行動させる（ターン終了時には行動しなくなる）
    - CardTags: 魔

上記８枚を「Card」インスタンスとして生成し、Deckに加える。

### 敵の初期化

以下の４体を「Enemy」インスタンスとして生成する。

〇を付けた方の技をそれぞれの敵の最初の技とする。

- オーク
    - HP: 50/50
    - 技
        - 〇たいあたり
            - 種別：アタック（単体攻撃）
            - 20ダメージ
        - ビルドアップ
            - 種別：スキル
            - 自分の状態に、筋力上昇（10）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- オークダンサー
    - HP: 50/50
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇戦いの舞い
            - 種別：スキル
            - 自分の状態に、加速（1）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- 触手
    - HP: 30/30
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 3回
        - 〇粘液飛ばし
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「ねばねば(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- かたつむり
    - HP: 10/10
    - 技
        - たいあたり
            - 種別：アタック（単体攻撃）
            - 10ダメージ
        - 〇酸を吐く：5ダメージ
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「腐食(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：硬い殻(20)：受けるダメージを-20する

### プレイヤーの初期化

- プレイヤーの初期HPは100/100。
- 特性なし。

### Battleの初期化

- 上記で作成した以下の値を引数として、Battleインスタンスを作成する
    - Player
    - Deck
- Hand：この時点では空
- DiscardPile：この時点では空
    - Events：この時点では空

## 2. 最初の自分のターン

(ここからがstart-player-turn の処理)
- ドローフェイズ
    - 最初のターンは、Deckの上から５枚をHandに加える。
    - 今回はテストなので、以下の５枚を引くことにする。
        - 天の鎖 × 3
        - 戦いの準備 × 1
        - 被虐のオーラ × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - この時点では何もない
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - 手札のカードを発動できるタイミング。
    - この時点で、次の敵の行動予測を全員分知らされる。
    - play-card１枚目：「被虐のオーラ」を「かたつむり」に発動する
        - 結果として起こること
            - マナが１減る
            - 「かたつむり」が「酸を吐く」の行動をする
            - 攻撃の点数計算が行われる
            - プレイヤーのHPが145になる
            - プレイヤーが敵の攻撃を受けたことにより、同じカードがプレイヤーの手札に追加される
                - 「酸を吐く」のカードが手札に追加
            - プレイヤーが敵の攻撃を受けたことにより、状態異常「腐食」のカードが１枚手札に追加される
                - Playerの状態異常は、手札に以下の状態異常カードを追加することで表現される。
                    - 腐食
                        - コスト1
                        - 敵の攻撃を受けるとき、ダメージ+10
            - 「かたつむり」は行動済みのため、このターンは何も行動しない状態になる
            - 手札の「被虐のオーラ」が捨て札に移動する
    - play-card２枚目：「天の鎖」を「」に発動する
        - 結果として起こること
            - マナが１減る
            - 「オーク」が、このターンは何も行動しない状態になる
            - 手札の「天の鎖」が手札から削除される。捨て札には移動しない
                - 「天の鎖」は、CardTag[消費] を持つため
    - 3枚目：「戦いの準備」を発動する
        - 結果として起こること
            - マナが１減る
            - 手札の「戦いの準備」が捨て札に移動する
            - 次の自分のターンの開始時に、マナ＋１のイベントを積む
- ターン終了

## 3. 最初の敵のターン

行動順に従い、敵の行動を処理していく

- オーク → 「天の鎖」によって行動が止まっているので、なにもしない
- オークダンサー → 「戦いの舞い」を発動。自身にState「加速（1）」を追加。
- 触手 → 「粘液飛ばし」を発動。
    - 結果として起こること
        - 攻撃の点数計算が行われる
            - プレイヤーは「腐食(1)」のStateを持つため、ダメージが+10される。そのため、15の単回攻撃になる。
        - プレイヤーのHPが80になる
        - プレイヤーが敵の攻撃を受けたことにより、同じカードがプレイヤーの手札に追加される
            - ダメージ15の「粘液飛ばし」のカードが手札に追加される。
        - 「粘液飛ばし」の効果により、状態異常「ねばねば」のカードが１枚手札に追加される
            - ねばねば
                - コスト1
                - 敵の連続攻撃を受けるとき、回数+1
- かたつむり → 行動済みのため、このターンは何も行動しない

## 4. ２回目の自分のターン

- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - 今回はテストなので、以下の２枚を引くことにする。
        - 天の鎖 × 1
        - 戦いの準備 × 1
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - 前のターンに発動した「戦いの準備」の効果が処理され、マナ＋１。
- メインフェイズ
    - 手札のカードを発動できるタイミング。
    - １枚目：「天の鎖」を「触手」に発動する
        - 結果として起こること
            - マナが１減る
            - 「触手」が、このターンは何も行動しない状態になる
            - 手札の「天の鎖」が手札から削除される。捨て札には移動しない
                - 「天の鎖」は、CardTag[消費] を持つため
    - ２枚目：「天の鎖」を「かたつむり」に発動する
        - 結果として起こること
            - マナが１減る
            - 「かたつむり」が、このターンは何も行動しない状態になる
            - 手札の「天の鎖」が手札から削除される。捨て札には移動しない
                - 「天の鎖」は、CardTag[消費] を持つため
    - 3枚目：「酸を吐く」を「かたつむり」に発動する
        - 結果として起こること
            - 攻撃の点数計算が行われる
                - 「酸を吐く」の打点は5ダメージ。
                - かたつむりは「硬い殻」の効果で、ダメージを-20する。
                - +5 -20 ＝ -15 なので、かたつむりはダメージを受けない。
            - かたつむりはダメージを受けず、ＨＰ10のまま。
            - 「酸を吐く」の効果により、「かたつむり」のStateに「腐食(1)」を追加。
            - 手札の「酸を吐く」が捨て札には移動する。
- ターン終了

## 5. ２回目の敵のターン

行動順に従い、敵の行動を処理していく

- オーク → 「ビルドアップ」を発動。自身にState「筋力上昇（10）」を追加。
- オークダンサー → 「乱れ突き」を発動する。
    - 結果として起こること
        - 攻撃の点数計算が行われる
            - 乱れ突きの元の設定は、10ダメージ × 2回
            - Playerは手札に「腐食」が１枚あるので、+10ダメージ。
            - オークダンサーはState「加速(1)」を持つので、攻撃回数+1
            - よって、20ダメージ × 3回。
        - プレイヤーのHPが20になる
        - プレイヤーが敵の攻撃を受けたことにより、同じカードがプレイヤーの手札に追加される
            - 20ダメージ × 3回の「乱れ突き」のカードが手札に追加される。
- 触手 → 「天の鎖」によって行動が止まっているので、なにもしない
- かたつむり → 「天の鎖」によって行動が止まっているので、なにもしない

## 6. ３回目の自分のターン

- ドローフェイズ
    - ２ターン目以降は、Deckの上から２枚をHandに加える。
    - デッキには、残り１枚しかないので、まず、以下の１枚を引く。
        - 天の鎖 × 1
    - 残り１枚のドローが残っているが、デッキが残っていないので、捨て札をシャッフルして、新しいデッキにする。
        - 捨て札の「被虐のオーラ」「戦いの準備」「酸を吐く」の３枚をシャッフルし、デッキにする。
    - 上から一枚引く。
        - 今回はテストなので、「酸を吐く」を引いたとする。
- 処理チェック
    - もし、自分のターン開始時に処理する必要があるイベントが積まれている場合は、ここで対応する。
    - 特に処理なし。
- メインフェイズ
    - 手札のカードを発動できるタイミング。
    - １枚目：手札の「乱れ突き」（1コスト、20ダメージ × 3回）を「オーク」に発動する
        - 結果として起こること
            - マナが１減る
            - 「オーク」のＨＰが０になり、倒される
            - 手札の「乱れ突き」が捨て札には移動
