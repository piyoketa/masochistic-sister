# このドキュメントは何？
- このドキュメントは、鉄花チームとの戦闘シナリオを `tests/integration/battleSample.spec.ts` と同等の粒度で文書化したものです。
- 記載された手順と検証項目に従い、シナリオ２のテストをメンテナンスしてください。

# 新カード
## 再装填
- Skill
- コスト1
- 効果：手札のうち、`cardType !== status` のカードをすべて捨て札に移し、捨てた枚数と同じ枚数だけ即座に引き直す（状態異常カードは手札に残る）。

# シナリオ2 鉄花チーム戦
## 1. 戦闘開始準備
### デッキの初期化
初期デッキは以下の9枚である（シナリオ1と完全に同じ順序だが、「疼き」を「再装填」に差し替える）。

- 天の鎖 × 4枚
- 被虐のオーラ × 2枚
- 戦いの準備 × 1枚
- 日課 × 1枚
- 再装填 × 1枚

上記9枚を「Card」インスタンスとして生成し、Deckに加える。

### 敵の初期化

以下の４体を「Enemy」インスタンスとして生成する。
これは、「鉄花チーム」として、EnemyTeamに登録する。

〇を付けた方の技をそれぞれの敵の最初の技とする。

- オークランサー
    - HP: 40/40
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇戦いの舞い
            - 種別：スキル
            - 自分の状態に、加速（1）を追加する
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- かまいたち
    - HP: 20/20
    - 技
        - 〇乱れ突き
            - 種別：アタック（連続攻撃）
            - 5ダメージ × 4回
        - 追い風
            - 種別：スキル
              - 対象：味方1体（新しい対象タグ）
              - 特殊効果：指定した味方1体に、State「加速(1)」を付与
                - なお、加速のmagnitudeは累積する（すでに加速(2)なら、+1されて加速(3)になる）
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：なし
- 鉄花
    - HP: 10/10
    - 技
        - 乱れ突き
            - 種別：アタック（連続攻撃）
            - 10ダメージ × 2回
        - 〇体液をかける
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「粘液(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：守りの花びら(3)
        - 毎ターン、自分にバリア(3)を付与
          - ドローフェイズ後、処理チェックの段階に行う（敵ターン開始時に発動する想定）
          - すでにバリアを持つ場合、毎ターンmagnitudeを3にリセットする
        - バリアとは
            - 攻撃1回分を無効(0ダメージ)にする
            - 連続攻撃の場合、攻撃回数分のバリアを消費する
                - 例えば、5ダメージ × 2回の連続攻撃をバリア(3)の敵に対して使った場合、攻撃は0ダメージ × 2回になり、バリアのmagnitudeは1になる
                - 例えば、5ダメージ × 4回の連続攻撃をバリア(3)の敵に対して使った場合、最初の3回の攻撃はバリアの効果で0になり、5ダメージ × 1回が与えられる
- なめくじ
    - HP: 30/30
    - 技
        - 〇殴打
            - 種別：アタック（単体攻撃）
            - 20ダメージ
        - 酸を吐く：5ダメージ
            - 種別：アタック（単体攻撃）
            - 5ダメージ
            - 特殊効果：State「腐食(1)」を付与
    - 技の発動順
        - ２つの技を交互にうつ。どちらが最初かは、初期化時にランダムに決定。
    - 特性：臆病　最後の1体になったとき、逃走する

### プレイヤーの初期化

- プレイヤーの初期HPは150/150、初期マナは3/3。
- Stateは無し。

### Battleの初期化

- 上記で作成した以下の値を引数として、Battleインスタンスを作成する。
    - Player
    - Deck
    - EnemyTeam（鉄花チーム）
- Hand：この時点では空
- DiscardPile：この時点では空
- Events：この時点では空

## 1ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - 最初のターンは、Deckの上から５枚をHandに加える。
    - 今回はテストなので、以下の５枚を引くことにする。
        - 天の鎖 × 2
        - 戦いの準備 × 1
        - 被虐のオーラ × 1
        - 日課 × 1
- 処理チェック
    - まだ処理するイベントは無い。守りの花びらによるバリア付与も未発動。
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「被虐のオーラ」を「鉄花」に使用する
        - 検証すべき結果
            - マナが2になる
            - 鉄花が「体液をかける」を即時発動する
            - プレイヤーのHPが145になる
            - 追加効果として手札に「体液をかける(5)」と状態異常カード「粘液(1)」が加わり、手札6枚になる
            - プレイヤーのStateが「粘液(1)」になる
            - 鉄花は「行動済み」状態になる
            - 使用した「被虐のオーラ」は捨て札へ移動する
    - play-card２枚目：「天の鎖」を「なめくじ」に使用する
        - 検証すべき結果
            - マナが1になる
            - なめくじがこのターン行動不可状態になる
            - 「天の鎖」はCardTag[消費] を持つため、手札から削除され捨て札には入らない
            - 手札は5枚になる（天の鎖・戦いの準備・日課・体液をかける・粘液）
    - play-card３枚目：「戦いの準備」を使用する
        - 検証すべき結果
            - マナが0になる
            - 使用した「戦いの準備」が捨て札に移動し、手札が4枚になる
            - 次の自分のターン開始時に、マナ＋１のイベントが積まれる

(ここからがend-player-turn の処理)
- 敵ターン（行動順に処理）
    - オークランサー → 「戦いの舞い」で自身に加速(1)
    - かまいたち → 「乱れ突き」を発動。粘液(1)の影響で5回攻撃になり、合計25ダメージ
    - 鉄花 → 既に行動済みのため何もしない
    - なめくじ → 天の鎖の効果により行動しない

検証すべき結果
- プレイヤーのHPが120になる
- 手札が5枚で、内訳は「天の鎖」「日課」「体液をかける(5)」「粘液」「乱れ突き(5×5)」
- プレイヤーのStateは「粘液(1)」のみ
- 敵の行動（Action）名が全て上記通り
(ここまでがend-player-turn の処理)

## 2ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - ２ターン目以降はDeckの上から２枚を引く。
    - 今回はテストなので、以下の２枚を引くことにする。
        - 天の鎖
        - 被虐のオーラ
- 処理チェック
    - 前ターンの「戦いの準備」の効果でマナが+1され、開始マナは4になる
    - 敵ターン開始時に守りの花びらが発動しているため、鉄花はバリア(3)を保持している
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「乱れ突き(5×5)」を「鉄花」に使用する
        - 検証すべき結果
            - マナが3になる
            - 鉄花のバリア3が最初の3ヒットで消費され、残り2ヒットで合計10ダメージを与えて「撃破」状態になる
            - 鉄花のバリアが0になる
            - 使用した「乱れ突き(5×5)」が捨て札に移動し、手札が6枚になる
    - play-card２枚目：「被虐のオーラ」を「オークランサー」に使用する
        - 検証すべき結果
            - マナが2になる
            - オークランサーが即座に「乱れ突き」を発動。加速(1)とプレイヤーの粘液(1)により10ダメージ×4回が発生し、プレイヤーのHPが80になる
            - プレイヤーの手札に「乱れ突き(10×4)」が追加され、手札6枚を維持する
            - オークランサーは「行動済み」状態になる
            - 使用した「被虐のオーラ」が捨て札に移動する
    - play-card３枚目：「乱れ突き(10×4)」を「オークランサー」に使用する
        - 検証すべき結果
            - マナが1になる
            - オークランサーに40ダメージが入り、「撃破」状態になる
            - 使用した「乱れ突き(10×4)」が捨て札に移動し、手札が5枚になる
    - play-card４枚目：「日課」を使用する
        - 検証すべき結果
            - マナが0になる
            - 山札の上から2枚（今回は「再装填」と「天の鎖」）を引き、手札が6枚になる
            - 使用した「日課」が捨て札に移動する
            - この時点の手札は「天の鎖」×3、「体液をかける(5)」、「粘液」、「再装填」である

(ここからがend-player-turn の処理)
- 敵ターン
    - オークランサー → 撃破されているので行動しない
    - かまいたち → 追い風を発動し、事前に計画したターゲット（オークランサー）が不在のため不発（ログは残るが効果は無し）
    - 鉄花 → 撃破されているので行動しない
    - なめくじ → 「酸を吐く」を発動
        - プレイヤーのHPが75になる
        - プレイヤーの手札に「酸を吐く(5)」と状態異常カード「腐食(1)」が追加され、手札が8枚になる
        - プレイヤーのStateに「腐食(1)」が追加され、現在のStateは「粘液(1)」「腐食(1)」

検証すべき結果
- 手札が8枚で、内訳は「天の鎖」×3、「体液をかける(5)」、「再装填」、「酸を吐く(5)」、「粘液」、「腐食」
- プレイヤーのHPが75
- 敵の行動（Action）名が全て上記通り
(ここまでがend-player-turn の処理)

## 3ターン目
(ここからがstart-player-turn の処理)
- ドローフェイズ
    - 手札上限10枚に余裕があるため、予定通り2枚引く。
    - デッキが空なので、捨て札（被虐のオーラ×2、戦いの準備、日課、乱れ突き(5×5)、乱れ突き(10×4)）をシャッフルし、新しい山札を形成する。
    - 今回はテストなので、以下の順でドローする。
        - 被虐のオーラ
        - 戦いの準備
    - ドロー後の手札は10枚になる。
- 処理チェック
    - 追加のイベントは無い。守りの花びらは鉄花撃破済みのため発動しない。
(ここまでがstart-player-turn の処理)

- メインフェイズ
    - play-card１枚目：「再装填」を使用する
        - 検証すべき結果
            - マナが2になる
            - 手札から状態異常カード以外（天の鎖×3、体液をかける(5)、酸を吐く(5)、被虐のオーラ、戦いの準備）の7枚が捨て札に送られる
            - 手札には「粘液」「腐食」の2枚だけが残る
            - 7枚分のドローを行い、結果として「乱れ突き(5×5)」「天の鎖」×2「体液をかける(5)」「酸を吐く(5)」「被虐のオーラ」「戦いの準備」を取得する（山札が尽きたタイミングで捨て札を再構築してドローを継続する）
            - 再装填の効果終了時、手札は9枚（状態異常2枚＋新しく引いた7枚）になる
    - play-card２枚目：「乱れ突き(5×5)」を「かまいたち」に使用する
        - 検証すべき結果
            - マナが1になる
            - かまいたちに25ダメージが入り、「撃破」状態になる
            - 使用した「乱れ突き(5×5)」が捨て札に移動する
            - 残存敵がなめくじ1体だけになるため、臆病の効果でなめくじが即座に「逃走」状態へ移行する

(ここからがend-player-turn の処理)
- 敵ターン
    - 生存している敵がいないため行動無し
- バトルステータスが「victory」になる

検証すべき結果
- Battleの`status`が`victory`
- なめくじの`status`が`escaped`
- プレイヤーの最終HPが75、Stateが「粘液(1)」「腐食(1)」のままであること
